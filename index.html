<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XT UND Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    <!-- html2canvas removed - using native Canvas API -->
    <style>
      /* Base Settings */
      body {
        font-family: 'Inter', sans-serif; /* UI Font */
        background-color: #121212;
        color: #e5e5e5;
        padding-bottom: 90px; /* Space for bottom nav */
        -webkit-tap-highlight-color: transparent;
      }
      
      /* Gamer Font for specific headers */
      .font-gamer { font-family: 'Orbitron', sans-serif; }

      /* Custom scrollbar */
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: #1a1a1a; }
      ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
      
      /* Hide scrollbar for horizontal scroll areas but keep functionality */
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

      /* Animations */
      .fade-in { animation: fadeIn 0.2s ease-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

      /* Input Styles */
      .input-modern {
          background: #1e1e1e;
          border: 1px solid #333;
          color: white;
          border-radius: 8px;
          padding: 10px 12px;
          font-size: 14px;
          transition: all 0.2s;
          width: 100%;
          outline: none;
      }
      .input-modern:focus {
          border-color: #ea580c;
          background: #252525;
      }
      
      .input-compact {
          background: #121212;
          border: 1px solid #333;
          color: white;
          border-radius: 4px;
          padding: 4px;
          font-size: 12px;
          text-align: center;
          width: 100%;
          outline: none;
          transition: border-color 0.2s;
      }
      .input-compact:focus { border-color: #ea580c; }
      
      /* Remove arrows from number inputs */
      input[type=number]::-webkit-inner-spin-button, 
      input[type=number]::-webkit-outer-spin-button { 
        -webkit-appearance: none; 
        margin: 0; 
      }
      input[type=number] {
        -moz-appearance: textfield;
      }

      /* Card Style */
      .card {
          background: #1e1e1e;
          border: 1px solid #2a2a2a;
          border-radius: 12px;
          padding: 16px;
          box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
      }

      /* File Upload Button */
      .file-upload-btn {
          position: relative;
          overflow: hidden;
          cursor: pointer;
          background-size: cover;
          background-position: center;
      }
      .file-upload-btn input[type=file] {
          position: absolute;
          top: 0; left: 0; width: 100%; height: 100%;
          opacity: 0;
          cursor: pointer;
          z-index: 10;
      }

      /* Leaderboard Specific Styles */
      .text-gold { color: #fbbf24; }
      .text-shadow { text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
      .text-shadow-sm { text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
      
      .bg-rank-1 { background: linear-gradient(90deg, #ea580c 0%, #9a3412 100%); }
      .bg-rank-3 { background: linear-gradient(90deg, #9a3412 0%, #431407 100%); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Top App Bar -->
    <header class="bg-[#1a1a1a] border-b border-[#333] sticky top-0 z-50">
        <div class="px-4 py-3 flex justify-between items-center max-w-7xl mx-auto">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-lg bg-orange-600 flex items-center justify-center shadow-lg shadow-orange-900/50">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012-2h2a2 2 0 012-2h2a2 2 0 012-2h2a2 2 0 012-2h2a2 2 0 012-2h2a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 002 2h2a2 2 0 002-2z" />
                    </svg>
                </div>
                <h1 class="text-lg font-bold text-white tracking-wide font-gamer"><span id="app-header-title">XT UND</span> <span class="text-orange-500 text-xs font-normal align-middle ml-1">MANAGER</span></h1>
            </div>
            <div class="text-xs text-gray-500 font-medium">v6.9.2 Logo Size Fix</div>
        </div>
        
        <!-- Group Selector (Horizontal Scroll) -->
        <div class="px-2 pb-2 bg-[#1a1a1a]">
            <div id="group-selector" class="flex gap-2 overflow-x-auto no-scrollbar py-1 px-2">
                <!-- Injected by JS -->
            </div>
        </div>
    </header>

    <main class="flex-1 max-w-md md:max-w-4xl mx-auto w-full p-4">

        <!-- VIEW: LEADERBOARD -->
        <div id="view-leaderboard" class="fade-in hidden w-full flex-col items-center">
             
             <!-- Action Bar -->
             <div class="w-full flex justify-between items-center mb-4">
                 <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">Results Board</h2>
                 <button onclick="downloadCanvas('results')" class="bg-orange-600 active:bg-orange-700 text-white px-3 py-2 rounded-lg text-xs font-bold shadow-lg shadow-orange-900/30 flex items-center gap-2 transition-transform active:scale-95">
                    <span>üíæ SAVE BOARD</span>
                </button>
             </div>

             <!-- Capture Area: Leaderboard -->
             <div class="w-full overflow-x-auto rounded-2xl shadow-2xl bg-black mb-10 border border-zinc-800">
                 <div id="preview-results" class="min-w-[550px] w-[550px] mx-auto bg-black flex justify-center">
                    <!-- Canvas injected here -->
                 </div>
             </div>

             <!-- Action Bar Top 3 -->
             <div class="w-full flex justify-between items-center mb-4 border-t border-zinc-800 pt-6">
                <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">Top 3 Banner</h2>
                <button onclick="downloadCanvas('top3')" class="bg-yellow-500 active:bg-yellow-600 text-black px-3 py-2 rounded-lg text-xs font-bold shadow-lg shadow-yellow-900/30 flex items-center gap-2 transition-transform active:scale-95">
                   <span>üíæ SAVE TOP 3</span>
               </button>
            </div>

             <!-- Capture Area: Top 3 Banner -->
             <div class="w-full overflow-x-auto rounded-2xl shadow-2xl bg-black mb-10 border border-zinc-800">
                <div id="preview-top3" class="min-w-[550px] w-[550px] mx-auto bg-black flex justify-center">
                    <!-- Canvas injected here -->
                </div>
            </div>

            <!-- Action Bar Confirmed Teams -->
            <div class="w-full flex justify-between items-center mb-4 border-t border-zinc-800 pt-6">
                <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">Confirmed Teams</h2>
                <button onclick="downloadCanvas('confirmed')" class="bg-blue-600 active:bg-blue-700 text-white px-3 py-2 rounded-lg text-xs font-bold shadow-lg shadow-blue-900/30 flex items-center gap-2 transition-transform active:scale-95">
                   <span>üíæ SAVE TEAMS</span>
               </button>
            </div>

             <!-- Capture Area: Confirmed Teams -->
             <div class="w-full overflow-x-auto rounded-2xl shadow-2xl bg-black mb-8 border border-zinc-800">
                <div id="preview-confirmed" class="min-w-[550px] w-[550px] mx-auto bg-black flex justify-center">
                    <!-- Canvas injected here -->
                </div>
            </div>

            <!-- Action Bar Presentation -->
            <div class="w-full flex justify-between items-center mb-4 border-t border-zinc-800 pt-6">
                <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">Presentation</h2>
                <button onclick="downloadCanvas('presentation')" class="bg-purple-600 active:bg-purple-700 text-white px-3 py-2 rounded-lg text-xs font-bold shadow-lg shadow-purple-900/30 flex items-center gap-2 transition-transform active:scale-95">
                   <span>üíæ SAVE INFO</span>
               </button>
            </div>

             <!-- Capture Area: Presentation -->
             <div class="w-full overflow-x-auto rounded-2xl shadow-2xl bg-black mb-8 border border-zinc-800">
                <div id="preview-presentation" class="min-w-[550px] w-[550px] mx-auto bg-black flex justify-center">
                    <!-- Canvas injected here -->
                </div>
            </div>
        </div>

        <!-- VIEW: EDITOR (Data Entry) -->
        <div id="view-register" class="fade-in hidden w-full">
            <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                <span class="w-1 h-6 bg-orange-600 rounded-full block"></span>
                Edit Group <span id="reg-group-title" class="text-orange-500">A</span>
            </h2>

            <!-- Add Team Card -->
            <div class="card mb-6 bg-[#1a1a1a] border-[#333]">
                <h3 class="text-xs font-bold text-gray-400 uppercase mb-3">Add New Team</h3>
                <form id="add-team-form" class="flex gap-2 items-start">
                    <div class="flex-1">
                        <input type="text" id="new-team-name" class="input-modern" placeholder="Team Name" required>
                    </div>
                    
                    <div class="file-upload-btn w-12 h-11 bg-zinc-800 border border-zinc-700 rounded-lg flex items-center justify-center hover:border-orange-500 transition-colors shrink-0">
                         <span class="text-xl">üõ°Ô∏è</span>
                         <input type="file" id="new-team-logo" accept="image/*">
                    </div>

                    <button type="submit" class="bg-white text-black font-bold h-11 px-4 rounded-lg hover:bg-gray-200 active:scale-95 transition-transform">
                        Add
                    </button>
                </form>
            </div>

            <!-- List of Teams -->
            <div id="teams-list" class="space-y-4">
                <!-- Injected by JS -->
            </div>
            
            <div class="h-12"></div>
        </div>

        <!-- VIEW: SETTINGS (Style Editor) -->
        <div id="view-style" class="fade-in hidden w-full pb-8">
            <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                <span class="w-1 h-6 bg-blue-500 rounded-full block"></span>
                Settings for Group <span id="style-group-title" class="text-blue-500">A</span>
            </h2>
            
            <div class="space-y-6">
                
                <!-- Section: Info -->
                <div class="card">
                    <h3 class="text-sm font-bold text-gray-300 uppercase mb-4 border-b border-gray-800 pb-2">Information</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-gray-500 block mb-1">Tournament Name</label>
                            <input type="text" id="tournamentName" class="input-modern" placeholder="XT UND">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">Date</label>
                                <input type="text" id="tournamentDate" class="input-modern" placeholder="DD/MM/YYYY">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">Time</label>
                                <input type="text" id="tournamentTime" class="input-modern" placeholder="HH:MM">
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 block mb-1">Registration Price (Paypal)</label>
                            <input type="text" id="registrationPrice" class="input-modern" placeholder="$5 USD">
                            <p class="text-[10px] text-gray-500 mt-1">Visible only in Presentation Banner</p>
                        </div>
                    </div>
                </div>

                <!-- Section: Top Text -->
                <div class="card">
                    <h3 class="text-sm font-bold text-gray-300 uppercase mb-4 border-b border-gray-800 pb-2">Top Banner Text</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-gray-500 block mb-1">Left (Small Text)</label>
                            <input type="text" id="footerTextLeft" class="input-modern" placeholder="FREE FIRE EUROPA">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 block mb-1">Right (Small Text)</label>
                            <input type="text" id="footerTextRight" class="input-modern" placeholder="XT UND">
                        </div>
                    </div>
                </div>

                <!-- Section: Assets -->
                <div class="card">
                    <h3 class="text-sm font-bold text-gray-300 uppercase mb-4 border-b border-gray-800 pb-2">Assets</h3>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <!-- Main Logo -->
                        <div class="space-y-2">
                            <label class="text-xs text-gray-500 block">Main Logo</label>
                            <div id="preview-logo-container" class="file-upload-btn w-full aspect-square bg-black border border-dashed border-gray-600 rounded-lg flex flex-col items-center justify-center hover:border-orange-500 transition-colors relative">
                                <span class="text-2xl mb-1 z-0">üõ°Ô∏è</span>
                                <span class="text-[10px] text-gray-400 z-0">Tap to upload</span>
                                <input type="file" id="logoImage" accept="image/*" class="z-20">
                            </div>
                            <button onclick="clearImage('logoImage')" class="w-full text-[10px] text-red-500 hover:underline">Remove Logo</button>
                        </div>

                        <!-- BG Image -->
                        <div class="space-y-2">
                            <label class="text-xs text-gray-500 block">Background</label>
                            <div id="preview-bg-container" class="file-upload-btn w-full aspect-square bg-black border border-dashed border-gray-600 rounded-lg flex flex-col items-center justify-center hover:border-orange-500 transition-colors relative">
                                <span class="text-2xl mb-1 z-0">üñºÔ∏è</span>
                                <span class="text-[10px] text-gray-400 z-0">Tap to upload</span>
                                <input type="file" id="backgroundImage" accept="image/*" class="z-20">
                            </div>
                            <button onclick="clearImage('backgroundImage')" class="w-full text-[10px] text-red-500 hover:underline">Remove BG</button>
                        </div>
                    </div>
                    
                    <!-- Sponsors -->
                    <div class="pt-2 border-t border-gray-800 mt-2">
                        <label class="text-xs text-gray-500 block mb-2">Footer Sponsors</label>
                        <div class="flex items-center gap-2 mb-2">
                            <div class="file-upload-btn bg-zinc-800 text-white px-3 py-2 rounded text-xs font-medium flex items-center gap-2 border border-zinc-700">
                                <span>+ Add Sponsor</span>
                                <input type="file" id="addSponsorInput" accept="image/*">
                            </div>
                        </div>
                        <div id="sponsor-list" class="flex flex-wrap gap-2">
                            <!-- Injected JS -->
                        </div>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="pt-4">
                    <button onclick="resetStyles()" class="w-full py-3 rounded-lg border border-red-900/50 text-red-500 text-sm font-medium hover:bg-red-900/10 transition-colors">
                        Reset Settings for Group <span id="reset-group-name">A</span>
                    </button>
                </div>
                
                <div class="pt-1">
                    <button onclick="resetData()" class="w-full py-3 rounded-lg border border-red-900/50 text-red-500 text-sm font-medium hover:bg-red-900/10 transition-colors">
                         Clear Group Data
                    </button>
                </div>

            </div>
        </div>

    </main>

    <!-- Bottom Navigation Bar -->
    <nav class="fixed bottom-0 left-0 w-full bg-[#1a1a1a]/95 backdrop-blur border-t border-[#333] z-50 pb-safe">
        <div class="flex justify-around items-center h-16 max-w-lg mx-auto">
            
            <button onclick="setView('LEADERBOARD')" id="nav-leaderboard" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-500 active:text-orange-500 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012-2h2a2 2 0 012-2h2a2 2 0 012-2h2a2 2 0 012-2h2a2 2 0 012-2h2a2 2 0 012-2h2a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 002 2h2a2 2 0 002-2z" />
                </svg>
                <span class="text-[10px] font-medium">Results</span>
            </button>

            <button onclick="setView('REGISTER')" id="nav-editor" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-500 active:text-orange-500 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                <span class="text-[10px] font-medium">Data Entry</span>
            </button>

            <button onclick="setView('STYLE')" id="nav-style" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-500 active:text-orange-500 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <span class="text-[10px] font-medium">Settings</span>
            </button>
            
        </div>
    </nav>

    <script>
        // --- State ---
        const GROUPS = ['A', 'B', 'C', 'D', 'E', 'F', 'ESPECIAL', 'FINALS', '3 SALAS'];
        let activeGroup = 'A';
        let currentView = 'LEADERBOARD'; 
        
        // Data Structure
        let data = { A: [], B: [], C: [], D: [], E: [], F: [], ESPECIAL: [], FINALS: [], '3 SALAS': [] };
        
        const DEFAULT_STYLE_TEMPLATE = {
            tournamentName: 'XT UND',
            tournamentDate: '24/11/2025',
            tournamentTime: '20:00 HRS',
            registrationPrice: '', // New Field
            footerTextLeft: 'EUROPA FREE FIRE',
            footerTextCenter: '',
            footerTextRight: 'XT UND SERIES',
            logoImage: null, 
            backgroundImage: null, 
            sponsorLogos: [],
        };
        
        // Styles map: styles[groupName] = styleObject
        let styles = {};
        // Initialize defaults
        GROUPS.forEach(g => {
            styles[g] = JSON.parse(JSON.stringify(DEFAULT_STYLE_TEMPLATE));
        });

        // --- Persistence (IndexedDB + LocalStorage Hybrid) ---
        
        // IndexedDB Configuration
        const DB_NAME = 'XT_UND_DB';
        const DB_VERSION = 1;
        const STORE_NAME = 'app_data';

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                };
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        async function dbSet(key, value) {
            try {
                const db = await openDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    const request = store.put(value, key);
                    request.onsuccess = () => resolve();
                    request.onerror = (e) => reject(e.target.error);
                });
            } catch (e) {
                console.error("DB Save Error:", e);
            }
        }

        async function dbGet(key) {
            try {
                const db = await openDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(STORE_NAME, 'readonly');
                    const store = tx.objectStore(STORE_NAME);
                    const request = store.get(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (e) => reject(e.target.error);
                });
            } catch (e) {
                console.error("DB Load Error:", e);
                return null;
            }
        }

        async function loadData() {
            try {
                // 1. Try IndexedDB first
                let storedData = await dbGet('xt_und_data_v2');
                let storedStyles = await dbGet('xt_und_styles_v3');

                // 2. Migration: Check LocalStorage if IDB is empty
                if (!storedData) {
                    const lsData = localStorage.getItem('xt_und_data_v2');
                    if (lsData) {
                        console.log("Migrating Data to IndexedDB...");
                        storedData = JSON.parse(lsData);
                        await dbSet('xt_und_data_v2', storedData);
                    }
                }
                
                if (!storedStyles) {
                    const lsStyles = localStorage.getItem('xt_und_styles_v3');
                    if (lsStyles) {
                        console.log("Migrating Styles to IndexedDB...");
                        storedStyles = JSON.parse(lsStyles);
                        await dbSet('xt_und_styles_v3', storedStyles);
                    }
                }

                // 3. Apply Data
                if (storedData) {
                    data = storedData;
                    if(!data.ESPECIAL) data.ESPECIAL = [];
                    if(!data['3 SALAS']) data['3 SALAS'] = [];
                }

                if (storedStyles) {
                    // Check for migration from V1 (Global Style) to V2 (Group Styles)
                    // Old format: { tournamentName: '...' }
                    // New format: { 'A': { tournamentName: ... }, 'B': ... }
                    
                    if (storedStyles.tournamentName) {
                        console.log("Migrating Styles from Global to Per-Group...");
                        // Propagate global style to all groups
                        GROUPS.forEach(g => {
                            styles[g] = { ...DEFAULT_STYLE_TEMPLATE, ...storedStyles };
                            // Fix legacy sponsor array issue during migration
                            if (styles[g].sponsorLogo && (!styles[g].sponsorLogos || styles[g].sponsorLogos.length === 0)) {
                                styles[g].sponsorLogos = [styles[g].sponsorLogo];
                            }
                        });
                        saveStyles(); // Save the new structure immediately
                    } else {
                        // New format - load directly
                        styles = storedStyles;
                        // Ensure all groups exist in styles (in case of new group addition)
                        GROUPS.forEach(g => {
                            if (!styles[g]) styles[g] = JSON.parse(JSON.stringify(DEFAULT_STYLE_TEMPLATE));
                        });
                    }
                }

                // Active group is small, keep using LS or default
                const storedGroup = localStorage.getItem('xt_und_active_group');
                if (storedGroup && GROUPS.includes(storedGroup)) activeGroup = storedGroup;

            } catch (e) {
                console.error("Error loading data", e);
                alert("Error loading data from storage. Please check console.");
            }
        }

        async function saveData() {
            try {
                await dbSet('xt_und_data_v2', data);
                localStorage.setItem('xt_und_active_group', activeGroup);
            } catch (e) { console.error("Save Data Error:", e); }
        }

        async function saveStyles() {
            try {
                await dbSet('xt_und_styles_v3', styles);
            } catch (e) { console.error("Save Styles Error:", e); }
        }

        // --- Logic ---
        function calculateMatchPoints(pos, kills) {
            if(!pos) return 0;
            let pts = 0;
            const p = parseInt(pos);
            const k = parseInt(kills) || 0;
            if (p === 1) pts = 12;
            else if (p === 2) pts = 9;
            else if (p === 3) pts = 8;
            else if (p === 4) pts = 7;
            else if (p === 5) pts = 6;
            else if (p === 6) pts = 5;
            else if (p === 7) pts = 4;
            else if (p === 8) pts = 3;
            else if (p === 9) pts = 2;
            else if (p === 10) pts = 1;
            return pts + k;
        }

        function getAggregatedData(group) {
            const teams = data[group] || [];
            const processed = teams.map(t => {
                let totalPoints = 0;
                let totalKills = 0;
                let booyahs = 0;
                t.matches.forEach(m => {
                    const k = parseInt(m.k) || 0;
                    const p = parseInt(m.p);
                    if(p === 1) booyahs++;
                    totalKills += k;
                    totalPoints += calculateMatchPoints(m.p, m.k);
                });
                return { ...t, points: totalPoints, kills: totalKills, booyah: booyahs };
            });
            return processed.sort((a, b) => {
                if(b.points !== a.points) return b.points - a.points;
                return b.kills - a.kills;
            });
        }

        // --- Navigation ---
        function setView(view) {
            currentView = view;
            document.getElementById('view-leaderboard').classList.add('hidden');
            document.getElementById('view-register').classList.add('hidden');
            document.getElementById('view-style').classList.add('hidden');
            document.getElementById('view-leaderboard').classList.remove('flex');

            if (view === 'LEADERBOARD') {
                document.getElementById('view-leaderboard').classList.remove('hidden');
                document.getElementById('view-leaderboard').classList.add('flex');
                renderAll();
            } else if (view === 'REGISTER') {
                document.getElementById('view-register').classList.remove('hidden');
                renderTeamEditor();
            } else if (view === 'STYLE') {
                document.getElementById('view-style').classList.remove('hidden');
                
                // Update Style Inputs for current group
                const s = styles[activeGroup];
                document.getElementById('style-group-title').textContent = activeGroup;
                document.getElementById('reset-group-name').textContent = activeGroup;
                
                document.getElementById('tournamentName').value = s.tournamentName || '';
                document.getElementById('tournamentDate').value = s.tournamentDate || '';
                document.getElementById('tournamentTime').value = s.tournamentTime || '';
                document.getElementById('registrationPrice').value = s.registrationPrice || ''; // New
                document.getElementById('footerTextLeft').value = s.footerTextLeft || '';
                document.getElementById('footerTextRight').value = s.footerTextRight || '';
                
                // Update Image Previews in Settings
                updateImagePreview('preview-logo-container', s.logoImage, 'üõ°Ô∏è');
                updateImagePreview('preview-bg-container', s.backgroundImage, 'üñºÔ∏è');
                
                renderSponsorListInSettings();
            }
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('text-orange-500'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.add('text-gray-500'));
            if(view === 'LEADERBOARD') document.getElementById('nav-leaderboard').classList.add('text-orange-500');
            if(view === 'REGISTER') document.getElementById('nav-editor').classList.add('text-orange-500');
            if(view === 'STYLE') document.getElementById('nav-style').classList.add('text-orange-500');
        }
        
        function updateImagePreview(containerId, imageSrc, icon) {
             const container = document.getElementById(containerId);
             const input = container.querySelector('input');
             container.innerHTML = '';
             if (imageSrc) {
                const img = document.createElement('img');
                img.src = imageSrc;
                img.className = 'absolute inset-0 w-full h-full object-cover z-10 rounded-lg opacity-50 hover:opacity-100 transition-opacity';
                container.appendChild(img);
             } else {
                 container.innerHTML = `<span class="text-2xl mb-1 z-0">${icon}</span><span class="text-[10px] text-gray-400 z-0">Tap to upload</span>`;
             }
             container.appendChild(input);
        }
        
        // --- Render Helpers ---
        function renderGroupButtons() {
            const container = document.getElementById('group-selector');
            container.innerHTML = '';
            
            GROUPS.forEach(g => {
                const btn = document.createElement('button');
                const isActive = g === activeGroup;
                btn.className = `whitespace-nowrap px-4 py-1.5 rounded-full text-xs font-bold transition-all ${
                    isActive 
                    ? 'bg-orange-600 text-white shadow-lg shadow-orange-900/40' 
                    : 'bg-zinc-800 text-gray-400 hover:bg-zinc-700 hover:text-white'
                }`;
                btn.textContent = (g === 'ESPECIAL' || g === 'FINALS') ? g : (g.length > 2 ? g : `GROUP ${g}`);
                btn.onclick = () => {
                    activeGroup = g;
                    saveData();
                    renderGroupButtons();
                    
                    // Logic to refresh view content based on current view
                    if(currentView === 'REGISTER') renderTeamEditor(); 
                    if(currentView === 'STYLE') setView('STYLE'); // Refreshes inputs
                    if(currentView === 'LEADERBOARD') renderAll();
                };
                container.appendChild(btn);
            });
        }
        
        function renderTeamEditor() {
            const container = document.getElementById('teams-list');
            const title = document.getElementById('reg-group-title');
            if(title) title.textContent = activeGroup;
            
            container.innerHTML = '';
            const teams = data[activeGroup] || [];

            teams.forEach(team => {
                const div = document.createElement('div');
                div.className = 'card bg-[#1e1e1e] border border-[#333] p-3 rounded-lg animate-fade-in mb-3';
                
                // Header: Logo, Name, Delete
                let logoHtml = `<div class="w-10 h-10 bg-black rounded flex items-center justify-center border border-gray-700 text-xs text-gray-500 overflow-hidden relative group cursor-pointer">
                    ${team.logo ? `<img src="${team.logo}" class="w-full h-full object-cover">` : 'üõ°Ô∏è'}
                    <input type="file" onchange="updateTeamLogo('${team.id}', this)" class="absolute inset-0 opacity-0 cursor-pointer">
                </div>`;

                let matchesHtml = '';
                for(let i=0; i<5; i++) {
                     const m = team.matches[i] || {p:'', k:''};
                     matchesHtml += `
                        <div class="bg-black/50 p-1 rounded border border-gray-800 flex flex-col gap-1 w-[45px]">
                            <span class="text-[8px] text-gray-500 text-center">M${i+1}</span>
                            <input type="number" value="${m.p}" onchange="updateMatch('${team.id}', ${i}, 'p', this.value)" class="input-compact text-orange-400 font-bold border-orange-900/30" placeholder="#">
                            <input type="number" value="${m.k}" onchange="updateMatch('${team.id}', ${i}, 'k', this.value)" class="input-compact bg-zinc-900" placeholder="K">
                        </div>
                     `;
                }

                div.innerHTML = `
                    <div class="flex items-center gap-3 mb-3">
                        ${logoHtml}
                        <input type="text" value="${team.name}" onchange="updateTeamName('${team.id}', this.value)" class="input-modern flex-1" placeholder="Team Name">
                        <button onclick="deleteTeam('${team.id}')" class="text-red-500 text-xs hover:bg-red-900/20 p-2 rounded">Delete</button>
                    </div>
                    <div class="flex gap-1 overflow-x-auto pb-1 no-scrollbar">
                        ${matchesHtml}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // --- Actions ---
        function updateMatch(id, index, type, value) {
            const teams = data[activeGroup];
            const team = teams.find(t => t.id === id);
            if(team) {
                if(!team.matches[index]) team.matches[index] = {p:'', k:''};
                team.matches[index][type] = value;
                saveData();
            }
        }

        function updateTeamName(id, value) {
            const team = data[activeGroup].find(t => t.id === id);
            if(team) { team.name = value; saveData(); }
        }

        function updateTeamLogo(id, input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const team = data[activeGroup].find(t => t.id === id);
                    if(team) { team.logo = e.target.result; saveData(); renderTeamEditor(); }
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function deleteTeam(id) {
            if(confirm('Delete this team?')) {
                data[activeGroup] = data[activeGroup].filter(t => t.id !== id);
                saveData();
                renderTeamEditor();
            }
        }

        function resetStyles() {
            if(confirm(`Reset all styles for Group ${activeGroup}?`)) { 
                styles[activeGroup] = JSON.parse(JSON.stringify(DEFAULT_STYLE_TEMPLATE)); 
                saveStyles(); 
                setView('STYLE'); 
                renderAll(); 
            }
        }

        function resetData() {
            if(confirm(`Clear all data for Group ${activeGroup}?`)) { data[activeGroup] = []; saveData(); renderTeamEditor(); renderAll(); }
        }

        function clearImage(key) {
            styles[activeGroup][key] = null;
            saveStyles();
            setView('STYLE'); // refresh previews
            renderAll();
        }

        function handleImageUpload(e, key) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    styles[activeGroup][key] = evt.target.result;
                    saveStyles();
                    setView('STYLE'); // refresh previews
                    renderAll();
                };
                reader.readAsDataURL(file);
            }
        }

        function renderSponsorListInSettings() {
            const container = document.getElementById('sponsor-list');
            container.innerHTML = '';
            const s = styles[activeGroup];
            (s.sponsorLogos || []).forEach((logo, idx) => {
                const div = document.createElement('div');
                div.className = 'relative w-10 h-10 border border-zinc-700 rounded bg-black flex items-center justify-center';
                div.innerHTML = `<img src="${logo}" class="max-w-full max-h-full object-contain"><button onclick="removeSponsor(${idx})" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-3 h-3 flex items-center justify-center text-[8px]">&times;</button>`;
                container.appendChild(div);
            });
        }

        function removeSponsor(idx) {
            styles[activeGroup].sponsorLogos.splice(idx, 1);
            saveStyles();
            renderSponsorListInSettings();
            renderAll();
        }
        
        // ==========================================
        // CANVAS RENDERING ENGINE (No external libs)
        // ==========================================

        const CANVAS_WIDTH = 550;
        // Fonts
        const FONT_GAMER = "900 italic 32px Orbitron, sans-serif";
        const FONT_GAMER_SM = "700 italic 24px Orbitron, sans-serif";
        const FONT_SUBTITLE = "700 12px Orbitron, sans-serif";
        const FONT_NORMAL = "400 12px Inter, sans-serif";
        const FONT_BOLD = "700 12px Inter, sans-serif";

        async function loadImage(src) {
            return new Promise((resolve) => {
                if(!src) resolve(null);
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.onload = () => resolve(img);
                img.onerror = () => resolve(null);
                img.src = src;
            });
        }

        function drawRoundedRect(ctx, x, y, w, h, r) {
            if (w < 2 * r) r = w / 2;
            if (h < 2 * r) r = h / 2;
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.arcTo(x + w, y, x + w, y + h, r);
            ctx.arcTo(x + w, y + h, x, y + h, r);
            ctx.arcTo(x, y + h, x, y, r);
            ctx.arcTo(x, y, x + w, y, r);
            ctx.closePath();
            ctx.fill();
        }

        // --- Draw Header (Logo, Title, Group, Date/Time) ---
        async function drawHeader(ctx, title, group, date, time, bgImage, logoImage, textLeft, textRight, isPresentation = false) {
            // Background
            ctx.fillStyle = "#000000";
            ctx.fillRect(0, 0, CANVAS_WIDTH, ctx.canvas.height);
            
            if (bgImage) {
                // Draw BG centered cover
                const aspect = bgImage.width / bgImage.height;
                let dh = CANVAS_WIDTH / aspect;
                // If image is too short for canvas, scale by height
                if(dh < ctx.canvas.height) {
                    dh = ctx.canvas.height;
                    const dw = dh * aspect;
                     ctx.drawImage(bgImage, (CANVAS_WIDTH - dw)/2, 0, dw, dh);
                } else {
                     ctx.drawImage(bgImage, 0, (ctx.canvas.height - dh)/2, CANVAS_WIDTH, dh);
                }
                // Overlay
                ctx.fillStyle = "rgba(0,0,0,0.6)";
                ctx.fillRect(0,0, CANVAS_WIDTH, ctx.canvas.height);
            }

            // Draw Top Texts (Previously Footer Texts)
            ctx.font = "italic bold 10px Inter";
            ctx.fillStyle = "#a1a1aa"; // Zinc-400 for visibility
            
            // Left Text
            ctx.textAlign = "left";
            ctx.fillText(textLeft, 25, 25);

            // Right Text
            ctx.textAlign = "right";
            ctx.fillText(textRight, CANVAS_WIDTH - 25, 25);


            let currentY = 30; // Increased spacing

            // Tournament Logo
            if (logoImage) {
                // Modified: Bigger logo for standard views (was 45 -> 75)
                const logoH = isPresentation ? 140 : 75;
                const logoW = logoImage.width * (logoH / logoImage.height);
                ctx.drawImage(logoImage, (CANVAS_WIDTH - logoW) / 2, currentY, logoW, logoH);
                
                // Modified: Dynamic gap
                currentY += logoH + 20; 
            } else {
                currentY += 20;
            }

            // Tournament Title
            ctx.font = FONT_GAMER;
            ctx.fillStyle = "#ffffff";
            ctx.textAlign = "center";
            ctx.shadowColor = "rgba(0,0,0,0.5)";
            ctx.shadowBlur = 10;
            ctx.fillText(title.toUpperCase(), CANVAS_WIDTH / 2, currentY + 10);
            ctx.shadowBlur = 0;
            currentY += isPresentation ? 25 : 30; // Compact gap for presentation

            // Subtitle
            ctx.font = FONT_SUBTITLE;
            ctx.fillStyle = "#fbbf24"; // Gold
            ctx.letterSpacing = "4px"; 
            let subtitle = "OFFICIAL RESULTS";
            if(ctx.canvas.id.includes("top3")) subtitle = "TOP 3 TEAMS";
            if(ctx.canvas.id.includes("confirmed")) subtitle = "CONFIRMED TEAMS";
            if(ctx.canvas.id.includes("presentation")) subtitle = "SEASON INFO";
            
            ctx.fillText(subtitle, CANVAS_WIDTH / 2, currentY);
            currentY += isPresentation ? 20 : 20; // Increased to 20 from 15

            // Group
            if (group) {
                ctx.font = "bold 10px Orbitron";
                ctx.fillStyle = "#a1a1aa";
                ctx.letterSpacing = "2px";
                
                const groupText = (group === 'ESPECIAL' || group === '3 SALAS' || group === 'FINALS') ? group : `GROUP ${group}`;
                ctx.fillText(groupText, CANVAS_WIDTH / 2, currentY);
                currentY += 20; 
            } else {
                currentY += isPresentation ? 25 : 15; // Increased to 25 from 10/20 for presentation pills
            }

            // Date / Time Pills - Dynamic Width & Vertical Centering Fix
            ctx.font = "bold 10px Inter";
            const dateStr = "üìÖ " + date;
            const timeStr = "‚è∞ " + time;
            
            const dateMetrics = ctx.measureText(dateStr);
            const timeMetrics = ctx.measureText(timeStr);
            
            // Minimum 100px, add generous padding
            const padding = 30; 
            const minW = 110;
            const dateW = Math.max(minW, dateMetrics.width + padding);
            const timeW = Math.max(minW, timeMetrics.width + padding);
            
            const pillH = 24;
            const gap = 15;
            
            // Center the whole block
            const totalWidth = dateW + gap + timeW;
            const startX = (CANVAS_WIDTH - totalWidth) / 2;
            
            // Use middle baseline for perfect vertical alignment
            ctx.textBaseline = "middle";
            const textY = currentY + (pillH / 2);

            // Date Pill
            ctx.fillStyle = "rgba(24, 24, 27, 0.8)";
            ctx.strokeStyle = "#3f3f46";
            drawRoundedRect(ctx, startX, currentY, dateW, pillH, 4);
            ctx.stroke();
            ctx.fillStyle = "#d4d4d8";
            // textAlign is already center from previous section
            ctx.fillText(dateStr, startX + dateW/2, textY);

            // Time Pill
            const timeX = startX + dateW + gap;
            ctx.fillStyle = "rgba(24, 24, 27, 0.8)";
            drawRoundedRect(ctx, timeX, currentY, timeW, pillH, 4);
            ctx.stroke();
            ctx.fillStyle = "#d4d4d8";
            ctx.fillText(timeStr, timeX + timeW/2, textY);
            
            // Reset baseline
            ctx.textBaseline = "alphabetic";

            return currentY + (isPresentation ? 30 : 60); // Reduced return padding for presentation
        }

        async function drawFooter(ctx, yPosition, sponsors) {
             const footerH = 80; // Increased height for bigger logos
             const startY = ctx.canvas.height - footerH;
             
             // Divider
             ctx.beginPath();
             ctx.moveTo(25, startY);
             ctx.lineTo(CANVAS_WIDTH - 25, startY);
             ctx.strokeStyle = "rgba(255,255,255,0.1)";
             ctx.stroke();
             
             // Center Y of the footer area
             const centerY = startY + (footerH / 2);

             // Sponsors Text - Left Aligned
             ctx.fillStyle = "rgba(255,255,255,0.3)";
             ctx.font = "bold 12px Inter";
             ctx.textAlign = "left";
             ctx.textBaseline = "middle";
             
             const labelX = 25;
             ctx.fillText("SPONSORS", labelX, centerY);
             
             // Measure text to position logos after it
             const textMetrics = ctx.measureText("SPONSORS");
             let currentX = labelX + textMetrics.width + 25; // 25px gap after text

             // Sponsors Logos - Row Layout
             if (sponsors && sponsors.length > 0) {
                 const sponsorH = 50; // Requested bigger logos (was 35)
                 
                 for (let src of sponsors) {
                     const img = await loadImage(src);
                     if(img) {
                         const w = img.width * (sponsorH / img.height);
                         // Vertically centered relative to the footer height
                         ctx.drawImage(img, currentX, centerY - (sponsorH / 2), w, sponsorH);
                         currentX += w + 20; // Gap between logos
                     }
                 }
             }
             // Reset text baseline
             ctx.textBaseline = "alphabetic";
        }

        // --- Render: Leaderboard ---
        async function drawLeaderboard(canvas) {
            const ctx = canvas.getContext('2d');
            const s = styles[activeGroup];
            const bg = await loadImage(s.backgroundImage);
            const logo = await loadImage(s.logoImage);
            
            // Calculate dynamic height based on 12 rows
            const headerH = 280; // Increased from 240 to accommodate bigger logo
            const rowH = 32;
            const rows = 12;
            const footerH = 80; // Increased to 80 for bigger sponsors
            const totalH = headerH + (rows * rowH) + footerH + 20; 
            
            canvas.height = totalH; // Resize canvas

            let startY = await drawHeader(ctx, s.tournamentName, activeGroup, s.tournamentDate, s.tournamentTime, bg, logo, s.footerTextLeft, s.footerTextRight);
            
            // Header Row
            const colRank = 40;
            const colName = 200;
            const colWin = 350;
            const colKill = 410;
            const colPts = 500;
            
            ctx.fillStyle = "#71717a";
            ctx.font = "bold 10px Inter";
            ctx.textAlign = "left";
            ctx.fillText("WIN", colWin, startY - 10);
            ctx.fillText("KILLS", colKill, startY - 10);
            ctx.fillText("PTS", colPts, startY - 10);

            // Rows
            const teams = getAggregatedData(activeGroup);
            const displayData = [...teams];
            while (displayData.length < 12) displayData.push({ name: '---', booyah: 0, kills: 0, points: 0 });
            const top12 = displayData.slice(0, 12);

            for(let i=0; i<top12.length; i++) {
                const t = top12[i];
                const rank = i + 1;
                const y = startY + (i * (rowH + 4)); // 4px gap

                // Row BG
                let bgGradient = ctx.createLinearGradient(25, y, 525, y);
                let borderColor = "#27272a";
                let rankColor = "#52525b";
                let textColor = "#d4d4d8";
                let ptsColor = "#ffffff";

                if (rank === 1) {
                    bgGradient.addColorStop(0, "rgba(124, 45, 18, 0.4)"); 
                    bgGradient.addColorStop(1, "rgba(0,0,0,0.4)");
                    borderColor = "#f97316";
                    rankColor = "#f97316";
                    textColor = "#ffffff";
                    ptsColor = "#f97316";
                } else if (rank === 2) {
                    bgGradient.addColorStop(0, "rgba(30, 41, 59, 0.4)"); 
                    bgGradient.addColorStop(1, "rgba(0,0,0,0.4)");
                    borderColor = "#94a3b8";
                    rankColor = "#94a3b8";
                    textColor = "#ffffff";
                } else if (rank === 3) {
                    bgGradient.addColorStop(0, "rgba(124, 45, 18, 0.2)"); 
                    bgGradient.addColorStop(1, "rgba(0,0,0,0.4)");
                    borderColor = "#c2410c";
                    rankColor = "#c2410c";
                    textColor = "#ffffff";
                    ptsColor = "#c2410c";
                } else {
                    bgGradient = "rgba(24, 24, 27, 0.4)";
                }

                ctx.fillStyle = bgGradient;
                ctx.fillRect(25, y, 500, rowH);
                
                // Left Border
                ctx.fillStyle = borderColor;
                ctx.fillRect(25, y, 4, rowH);

                // Rank
                ctx.font = "italic 900 16px Inter";
                ctx.fillStyle = rankColor;
                ctx.textAlign = "left";
                ctx.fillText("#" + rank, 40, y + 22);

                // Logo
                let nameX = 85;
                if (t.logo) {
                    const tLogo = await loadImage(t.logo);
                    if(tLogo) {
                        ctx.drawImage(tLogo, 80, y + 4, 20, 20);
                        nameX = 110;
                    }
                }

                // Name
                ctx.font = "bold 12px Inter";
                ctx.fillStyle = textColor;
                ctx.fillText(t.name.toUpperCase(), nameX, y + 20);

                // Stats
                ctx.font = "bold 12px Inter";
                ctx.textAlign = "center";
                ctx.fillStyle = "#a1a1aa"; // Greyish for stats
                ctx.fillText(t.booyah > 0 ? t.booyah : '-', colWin + 10, y + 20);
                
                ctx.fillStyle = "#ffffff";
                ctx.fillText(t.kills, colKill + 15, y + 20);

                // PTS
                ctx.font = "italic 900 14px Inter";
                ctx.fillStyle = ptsColor;
                ctx.textAlign = "right";
                ctx.fillText(t.points, colPts + 15, y + 21);
            }

            await drawFooter(ctx, 0, s.sponsorLogos);
        }

        // --- Render: Top 3 ---
        async function drawTop3(canvas) {
            const ctx = canvas.getContext('2d');
            const s = styles[activeGroup];
            const bg = await loadImage(s.backgroundImage);
            const logo = await loadImage(s.logoImage);
            
            canvas.height = 600; // Increased height for more space

            await drawHeader(ctx, s.tournamentName, activeGroup, s.tournamentDate, s.tournamentTime, bg, logo, s.footerTextLeft, s.footerTextRight);

            const teams = getAggregatedData(activeGroup);
            const t1 = teams[0] || { name: 'TBD', kills: 0 };
            const t2 = teams[1] || { name: 'TBD', kills: 0 };
            const t3 = teams[2] || { name: 'TBD', kills: 0 };

            // Podium Base Y
            const podiumY = 480; // Lowered to account for header spacing
            const w1 = 150; 
            const w2 = 130;
            const w3 = 130;
            const h1 = 130;
            const h2 = 100;
            const h3 = 80;

            const cX = CANVAS_WIDTH / 2;
            const x1 = cX - w1/2;
            const x2 = x1 - w2 - 10;
            const x3 = x1 + w1 + 10;

            const drawPodiumBox = async (x, width, height, team, rankColor, rankName, rankNum) => {
                const boxY = podiumY - height;
                
                // Gradient Box
                const grad = ctx.createLinearGradient(x, boxY, x, podiumY);
                if (rankNum === 1) {
                    grad.addColorStop(0, "rgba(234, 179, 8, 0.6)");
                    grad.addColorStop(1, "rgba(234, 179, 8, 0.1)");
                    ctx.strokeStyle = "#facc15";
                } else if (rankNum === 2) {
                    grad.addColorStop(0, "rgba(82, 82, 91, 0.8)");
                    grad.addColorStop(1, "rgba(39, 39, 42, 0.4)");
                    ctx.strokeStyle = "#71717a";
                } else {
                    grad.addColorStop(0, "rgba(194, 65, 12, 0.6)");
                    grad.addColorStop(1, "rgba(194, 65, 12, 0.1)");
                    ctx.strokeStyle = "#ea580c";
                }
                
                // Box Body
                ctx.fillStyle = grad;
                // Custom rounded top rect
                ctx.beginPath();
                ctx.moveTo(x + 10, boxY);
                ctx.lineTo(x + width - 10, boxY);
                ctx.quadraticCurveTo(x + width, boxY, x + width, boxY + 10);
                ctx.lineTo(x + width, podiumY);
                ctx.lineTo(x, podiumY);
                ctx.lineTo(x, boxY + 10);
                ctx.quadraticCurveTo(x, boxY, x + 10, boxY);
                ctx.fill();
                
                // Top border
                ctx.beginPath();
                ctx.moveTo(x, boxY);
                ctx.lineTo(x + width, boxY);
                ctx.lineWidth = 2;
                ctx.stroke();

                // Team Name
                ctx.fillStyle = "#fff";
                ctx.font = "900 12px Orbitron";
                ctx.textAlign = "center";
                ctx.shadowColor = "black";
                ctx.shadowBlur = 4;
                ctx.fillText(team.name.toUpperCase(), x + width/2, boxY + 25);
                ctx.shadowBlur = 0;

                // Rank Name
                ctx.fillStyle = rankColor;
                ctx.font = "bold 8px Orbitron";
                ctx.fillText(rankName.toUpperCase(), x + width/2, boxY + 38);

                // Kills
                ctx.fillStyle = "rgba(0,0,0,0.5)";
                drawRoundedRect(ctx, x + width/2 - 25, boxY + 45, 50, 16, 4);
                ctx.fillStyle = "#fff";
                ctx.font = "bold 10px Inter";
                ctx.fillText(team.kills + " KILLS", x + width/2, boxY + 56);

                // Logo
                const logoSize = rankNum === 1 ? 140 : 100;
                const logoY = boxY - logoSize + 10; // Raised to +10 from +25
                
                if (team.logo) {
                    const img = await loadImage(team.logo);
                    if(img) {
                        // Drop shadow
                        ctx.shadowColor = rankNum === 1 ? "rgba(234,179,8,0.5)" : "rgba(255,255,255,0.2)";
                        ctx.shadowBlur = 20;
                        // Centered containment
                        const ratio = Math.min(logoSize / img.width, logoSize / img.height);
                        const lw = img.width * ratio;
                        const lh = img.height * ratio;
                        ctx.drawImage(img, x + (width - lw)/2, logoY + (logoSize - lh)/2, lw, lh);
                        ctx.shadowBlur = 0;
                    }
                } else {
                    // Placeholder Shield
                    ctx.font = "900 80px Inter";
                    ctx.fillStyle = "rgba(255,255,255,0.1)";
                    ctx.fillText("üõ°Ô∏è", x + width/2, logoY + 80);
                    ctx.font = "900 40px Inter";
                    ctx.fillStyle = "rgba(0,0,0,0.5)";
                    ctx.fillText(rankNum, x + width/2, logoY + 80);
                }
            };

            // Order: 2, 1, 3 (z-index implicit by draw order, draw 2 and 3 first)
            await drawPodiumBox(x2, w2, h2, t2, "#a1a1aa", "SILVER", 2);
            await drawPodiumBox(x3, w3, h3, t3, "#fb923c", "BRONZE", 3);
            await drawPodiumBox(x1, w1, h1, t1, "#facc15", "CHAMPION", 1);

            await drawFooter(ctx, 0, s.sponsorLogos);
        }

        // --- Render: Confirmed ---
        async function drawConfirmed(canvas) {
            const ctx = canvas.getContext('2d');
            const s = styles[activeGroup];
            const bg = await loadImage(s.backgroundImage);
            const logo = await loadImage(s.logoImage);
            
            canvas.height = 700; // Increased from 650 to accommodate bigger logo header
            
            let startY = await drawHeader(ctx, s.tournamentName, activeGroup, s.tournamentDate, s.tournamentTime, bg, logo, s.footerTextLeft, s.footerTextRight);
            startY += 10; // Positive separation for better spacing

            const teams = data[activeGroup] || [];
            const displayData = [...teams];
            while (displayData.length < 12) displayData.push({ name: '', logo: null });
            const top12 = displayData.slice(0, 12);

            // Grid Config
            const cols = 4;
            const gap = 10;
            const boxSize = 100;
            const totalGridW = (cols * boxSize) + ((cols - 1) * gap);
            const startX = (CANVAS_WIDTH - totalGridW) / 2;
            
            for(let i=0; i<top12.length; i++) {
                const t = top12[i];
                const r = Math.floor(i / cols);
                const c = i % cols;
                const x = startX + c * (boxSize + gap);
                const y = startY + r * (boxSize + gap);

                // Box BG
                ctx.fillStyle = "rgba(24, 24, 27, 0.5)";
                ctx.strokeStyle = "#3f3f46";
                ctx.lineWidth = 1;
                drawRoundedRect(ctx, x, y, boxSize, boxSize, 8);
                ctx.stroke();

                // Number
                ctx.fillStyle = "rgba(255,255,255,0.3)";
                ctx.font = "bold 10px Inter";
                ctx.fillText(i + 1, x + 10, y + 15);

                // Logo
                if (t.logo) {
                    const img = await loadImage(t.logo);
                    if(img) {
                        const maxS = 85;
                        const ratio = Math.min(maxS / img.width, maxS / img.height);
                        const w = img.width * ratio;
                        const h = img.height * ratio;
                        ctx.drawImage(img, x + (boxSize - w)/2, y + (boxSize - h)/2 - 5, w, h);
                    }
                } else {
                     ctx.fillStyle = "rgba(255,255,255,0.05)";
                     ctx.font = "40px Inter";
                     ctx.textAlign = "center";
                     ctx.fillText("üõ°Ô∏è", x + boxSize/2, y + boxSize/2 + 15);
                     ctx.textAlign = "left"; // reset
                }
            }
            
            await drawFooter(ctx, 0, s.sponsorLogos);
        }

        // --- Render: Presentation (Registration Open) ---
        async function drawPresentation(canvas) {
            const ctx = canvas.getContext('2d');
            const s = styles[activeGroup];
            const bg = await loadImage(s.backgroundImage);
            const logo = await loadImage(s.logoImage);
            
            canvas.height = 600; 
            
            // Draw Header
            let startY = await drawHeader(ctx, s.tournamentName, null, s.tournamentDate, s.tournamentTime, bg, logo, s.footerTextLeft, s.footerTextRight, true);
            
            // Central Content - Big Text
            // MOVED UP: Fixed offset from startY instead of centered in remaining space
            const centerY = startY + 60; 
            
            // Glow effect for text
            ctx.shadowColor = "rgba(234, 88, 12, 0.5)";
            ctx.shadowBlur = 30;
            
            ctx.textAlign = "center";
            ctx.font = "900 italic 42px Orbitron, sans-serif";
            
            // Text 1: REGISTRATION
            ctx.fillStyle = "#ffffff";
            ctx.fillText("REGISTRATION", CANVAS_WIDTH / 2, centerY - 20);
            
            // Text 2: OPEN
            ctx.fillStyle = "#ea580c"; // Orange
            ctx.fillText("OPEN", CANVAS_WIDTH / 2, centerY + 20);
            
            ctx.shadowBlur = 0; // Reset shadow

            // Decorative Box around text
            const boxW = 400;
            const boxH = 100;
            ctx.strokeStyle = "rgba(234, 88, 12, 0.5)";
            ctx.lineWidth = 2;
            
            // Draw brackets style box
            const bx = (CANVAS_WIDTH - boxW) / 2;
            const by = centerY - 50;
            
            // Top Left
            ctx.beginPath();
            ctx.moveTo(bx + 20, by);
            ctx.lineTo(bx, by);
            ctx.lineTo(bx, by + 20);
            ctx.stroke();

            // Bottom Right
            ctx.beginPath();
            ctx.moveTo(bx + boxW - 20, by + boxH);
            ctx.lineTo(bx + boxW, by + boxH);
            ctx.lineTo(bx + boxW, by + boxH - 20);
            ctx.stroke();

            // Draw Price
            if (s.registrationPrice) {
                const priceY = centerY + 70; 
                
                // Background Pill for Price
                ctx.font = "bold 14px Orbitron"; // Measure text
                const priceText = `ENTRY: ${s.registrationPrice}`;
                const tm = ctx.measureText(priceText);
                const pillW = tm.width + 60;
                const pillH = 36;
                const pillX = (CANVAS_WIDTH - pillW) / 2;
                
                ctx.fillStyle = "rgba(0, 48, 135, 0.8)"; // Paypal Blue-ish
                ctx.strokeStyle = "#009cde";
                ctx.lineWidth = 1;
                drawRoundedRect(ctx, pillX, priceY, pillW, pillH, 18);
                ctx.stroke();
                
                // Text
                ctx.fillStyle = "#ffffff";
                ctx.textAlign = "center";
                ctx.fillText(priceText, CANVAS_WIDTH / 2, priceY + 23);
                
                // Paypal Label (Small) below
                ctx.font = "italic 10px Inter";
                ctx.fillStyle = "#a1a1aa";
                ctx.fillText("PAYMENT VIA PAYPAL", CANVAS_WIDTH / 2, priceY + 45);
            }

            await drawFooter(ctx, 0, s.sponsorLogos);
        }

        // --- Main Draw Controller ---
        async function renderCanvas(type, containerId) {
             const container = document.getElementById(containerId);
             container.innerHTML = '';
             const canvas = document.createElement('canvas');
             canvas.width = 550;
             canvas.id = "canvas-" + type;
             
             // Initial height, adjusted inside functions
             if(type === 'results') await drawLeaderboard(canvas);
             if(type === 'top3') await drawTop3(canvas);
             if(type === 'confirmed') await drawConfirmed(canvas);
             if(type === 'presentation') await drawPresentation(canvas);
             
             // Scale down for preview if needed via CSS, but canvas stays hi-res
             canvas.style.maxWidth = "100%";
             canvas.style.height = "auto";
             
             container.appendChild(canvas);
        }

        function renderAll() {
             renderCanvas('results', 'preview-results');
             renderCanvas('top3', 'preview-top3');
             renderCanvas('confirmed', 'preview-confirmed');
             renderCanvas('presentation', 'preview-presentation');
             renderGroupButtons();
        }

        function downloadCanvas(type) {
            const canvas = document.getElementById("canvas-" + type);
            if(canvas) {
                const link = document.createElement('a');
                // Use the style name of the current group
                const cleanName = (styles[activeGroup].tournamentName || 'XT_UND').replace(/[^a-z0-9]/gi, '_');
                link.download = `${cleanName}_${type}_${activeGroup}.png`;
                link.href = canvas.toDataURL('image/png', 1.0); // Max quality
                link.click();
            }
        }
        
        // Initial setup
        window.onload = function() {
            // Add Team
            document.getElementById('add-team-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const nameInput = document.getElementById('new-team-name');
                const logoInput = document.getElementById('new-team-logo');
                if(nameInput.value.trim()) {
                    const newTeam = { id: Date.now().toString(), name: nameInput.value.trim(), logo: null, matches: Array(5).fill(null).map(()=>({p:'', k:''})) };
                    const finish = () => {
                        if(!data[activeGroup]) data[activeGroup] = [];
                        data[activeGroup].push(newTeam);
                        saveData(); renderTeamEditor(); renderAll();
                        nameInput.value = ''; logoInput.value = '';
                    };
                    if(logoInput.files[0]) {
                        const r = new FileReader();
                        r.onload = (evt) => { newTeam.logo = evt.target.result; finish(); };
                        r.readAsDataURL(logoInput.files[0]);
                    } else finish();
                }
            });

            // Settings Listeners
            ['tournamentName', 'tournamentDate', 'tournamentTime', 'registrationPrice', 'footerTextLeft', 'footerTextRight'].forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => { 
                    styles[activeGroup][id] = e.target.value; 
                    saveStyles(); 
                    renderAll(); 
                });
            });

            // Image Uploads
            document.getElementById('logoImage').addEventListener('change', (e) => handleImageUpload(e, 'logoImage'));
            document.getElementById('backgroundImage').addEventListener('change', (e) => handleImageUpload(e, 'backgroundImage'));
            document.getElementById('addSponsorInput').addEventListener('change', (e) => {
                 if(e.target.files[0]){
                    const r = new FileReader();
                    r.onload = (evt) => { 
                        if(!styles[activeGroup].sponsorLogos) styles[activeGroup].sponsorLogos=[]; 
                        styles[activeGroup].sponsorLogos.push(evt.target.result); 
                        saveStyles(); 
                        renderSponsorListInSettings(); 
                        renderAll(); 
                        e.target.value=''; 
                    };
                    r.readAsDataURL(e.target.files[0]);
                 }
            });

            // Load Data & Init
            loadData().then(() => {
                setView('LEADERBOARD');
                renderGroupButtons();
            });
        };

    </script>
</body>
</html>
